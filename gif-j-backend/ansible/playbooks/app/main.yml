---
- hosts: all
  gather_facts: false

  vars_files:
    - vars.yml

  tasks:
    - name: Create a directory
      ansible.builtin.file:
        path: '{{ remote_dir_path }}'
        state: directory
        mode: 0750
        owner: '{{ ansible_user }}'
        group: '{{ ansible_user }}'

    - name: Fix ownership of existing directory contents
      ansible.builtin.shell: |
        chown -R {{ ansible_user }}:{{ ansible_user }} {{ remote_dir_path }} || true
        chmod -R u+rwX {{ remote_dir_path }} || true
      ignore_errors: true
      changed_when: false

    - name: Sync source
      ansible.builtin.synchronize:
        src: '../../../../{{ service_name }}'
        dest: '{{ remote_dir_path }}'
        delete: true
        rsync_opts:
          - '--chmod=Du=rwx,Dg=rx,Do=x,Fu=rw,Fg=r,Fo='

    - name: Create Docker network
      community.docker.docker_network:
        name: '{{ service_name }}-internal'
        driver: bridge
      when: docker_network_create

    - name: Stop and remove existing containers using docker compose down
      ansible.builtin.shell: |
        cd {{ remote_dir_path }}/{{ service_name }} && docker compose --project-name {{ category_name }}-{{ service_name_stage }} down || true
      ignore_errors: true
      changed_when: false

    - name: Find and stop any containers from this project
      ansible.builtin.shell: |
        # Find containers with the project name pattern
        CONTAINERS=$(docker ps -a --filter "name={{ category_name }}-{{ service_name_stage }}" --format "{{ '{{' }}.ID{{ '}}' }}" 2>/dev/null || true)
        if [ -n "$CONTAINERS" ]; then
          echo "$CONTAINERS" | xargs -r docker stop 2>/dev/null || true
          echo "$CONTAINERS" | xargs -r docker rm -f 2>/dev/null || true
        fi
      ignore_errors: true
      changed_when: false

    - name: Wait a moment for ports to be released
      ansible.builtin.pause:
        seconds: 3

    - name: Run Docker compose (scale up)
      ansible.builtin.include_tasks:
        file: tasks/run-docker-compose.yml
      vars:
        scale: 2

    - name: Sleep for a moment
      ansible.builtin.pause:
        seconds: '{{ docker_scaling_timeout }}'

    - name: Get old container ID
      ansible.builtin.shell: docker ps | grep '{{ category_name }}-{{ service_name_stage }}_app' | awk '{print $1}' | tail -n 1
      register: old_container_id

    - name: Remove old container
      community.docker.docker_container:
        name: '{{ old_container_id.stdout }}'
        state: absent
      when: old_container_id.stdout is defined

    - name: Run Docker compose (scale down)
      ansible.builtin.include_tasks:
        file: tasks/run-docker-compose.yml
      vars:
        scale: 1
